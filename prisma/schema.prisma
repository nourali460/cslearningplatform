// ---------------------------------------------------------
// Prisma schema for core learning platform
// ---------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------------------
// USERS  (Simple auth with plain-text passwords)
// ---------------------------------------------------------

model User {
  id               String   @id @default(uuid()) @db.Uuid
  email            String   @unique
  password         String                        // Plain-text password
  role             String                        // 'professor' | 'student' | 'admin'
  fullName         String?
  usernameSchoolId String?  @unique             // School ID (0-1000000) for students/professors, used in class codes
  isApproved       Boolean  @default(true)      // Professors need approval
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  professorClasses Class[]                  @relation("ProfessorClasses")
  enrollments      Enrollment[]             @relation("StudentEnrollments")
  submissions      AssessmentSubmission[]   @relation("SubmissionStudent")

  @@map("users")
}

// ---------------------------------------------------------
// COURSES  (Global course catalog)
// ---------------------------------------------------------

model Course {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique             // e.g. 'CS101'
  title       String                      // e.g. 'Intro to Java'
  description String?
  subject     String?
  level       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  // Relations
  classes     Class[]

  @@map("courses")
}

// ---------------------------------------------------------
// CLASSES  (A professor teaching a course in a term)
// ---------------------------------------------------------

model Class {
  id           String   @id @default(uuid()) @db.Uuid
  courseId     String   @db.Uuid
  professorId  String   @db.Uuid
  title        String                       // e.g. 'CS101 Section 01'
  term         String                       // e.g. 'Fall'
  year         Int                          // e.g. 2025
  section      String?
  classCode    String   @unique             // e.g. 'ALI-CS101-FA25-01'
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  course       Course                 @relation(fields: [courseId],    references: [id])
  professor    User                   @relation("ProfessorClasses", fields: [professorId], references: [id])
  enrollments  Enrollment[]
  assessments  Assessment[]
  rubrics      Rubric[]
  submissions  AssessmentSubmission[]

  @@map("classes")
}

// ---------------------------------------------------------
// ENROLLMENTS  (Students joining a class)
// ---------------------------------------------------------

model Enrollment {
  id         String   @id @default(uuid()) @db.Uuid
  classId    String   @db.Uuid
  studentId  String   @db.Uuid
  status     String   @default("active")
  createdAt  DateTime @default(now())

  // Relations
  class      Class @relation(fields: [classId],   references: [id])
  student    User  @relation("StudentEnrollments", fields: [studentId], references: [id])

  @@unique([classId, studentId])
  @@map("enrollments")
}

// ---------------------------------------------------------
// ENUMS
// ---------------------------------------------------------

enum AssessmentType {
  INTERACTIVE_LESSON
  LAB
  EXAM
  QUIZ
  DISCUSSION
}

enum SubmissionType {
  TEXT      // Text or URL only
  FILE      // File upload only
  BOTH      // Text and files
  NONE      // No submission required (e.g., in-class work)
}

enum SubmissionStatus {
  DRAFT        // Saved but not submitted
  SUBMITTED    // Turned in, awaiting grading
  GRADED       // Score assigned
  RETURNED     // Needs revision
  LATE         // Submitted after due date
}

// ---------------------------------------------------------
// ASSESSMENTS  (Labs / assignments / exams)
// ---------------------------------------------------------

model Assessment {
  id                    String         @id @default(uuid()) @db.Uuid
  classId               String         @db.Uuid
  title                 String
  slug                  String
  description           String?
  dueAt                 DateTime?
  maxPoints             Decimal        @default("100.00") @db.Decimal(5, 2)
  orderIndex            Int?
  type                  AssessmentType @default(LAB)
  submissionType        SubmissionType @default(BOTH)
  allowMultipleAttempts Boolean        @default(false)
  maxAttempts           Int            @default(1)
  createdAt             DateTime       @default(now())

  // Relations
  class       Class                  @relation(fields: [classId], references: [id])
  submissions AssessmentSubmission[]
  rubric      Rubric?                @relation(fields: [rubricId], references: [id])
  rubricId    String?                @db.Uuid

  @@map("assessments")
}

// ---------------------------------------------------------
// ASSESSMENT SUBMISSIONS  (Grades + attempts + feedback)
// ---------------------------------------------------------

model AssessmentSubmission {
  id              String           @id @default(uuid()) @db.Uuid
  assessmentId    String           @db.Uuid
  studentId       String           @db.Uuid
  classId         String?          @db.Uuid  // Direct class association for easier filtering (optional for migration)
  submittedAt     DateTime         @default(now())
  submissionText  String?          // Text content or URLs (GitHub, Google Docs, etc.)
  submissionFiles Json?            // Array of file metadata: [{filename, size, url, uploadedAt}]
  autoScore       Decimal?         @db.Decimal(5, 2)
  manualScore     Decimal?         @db.Decimal(5, 2)
  totalScore      Decimal?         @db.Decimal(5, 2)
  feedback        String?          // Professor's text feedback
  feedbackFiles   Json?            // Array of feedback file attachments
  status          SubmissionStatus @default(DRAFT)
  isLate          Boolean          @default(false)
  attemptNumber   Int              @default(1)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  assessment      Assessment @relation(fields: [assessmentId], references: [id])
  student         User       @relation("SubmissionStudent", fields: [studentId], references: [id])
  class           Class?     @relation(fields: [classId], references: [id])

  @@unique([assessmentId, studentId])
  @@index([classId, studentId])
  @@map("assessment_submissions")
}

// ---------------------------------------------------------
// RUBRICS  (Grading rubrics with criteria)
// ---------------------------------------------------------

model Rubric {
  id          String   @id @default(uuid()) @db.Uuid
  classId     String   @db.Uuid
  title       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  class       Class             @relation(fields: [classId], references: [id])
  criteria    RubricCriterion[]
  assessments Assessment[]

  @@map("rubrics")
}

model RubricCriterion {
  id          String  @id @default(uuid()) @db.Uuid
  rubricId    String  @db.Uuid
  title       String
  description String?
  maxPoints   Decimal @db.Decimal(5, 2)
  orderIndex  Int     @default(0)

  // Relations
  rubric Rubric @relation(fields: [rubricId], references: [id], onDelete: Cascade)

  @@map("rubric_criteria")
}
